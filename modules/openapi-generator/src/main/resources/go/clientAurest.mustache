// Code generated by interhyp-improved OpenAPI Generator (https://openapi-generator.tech); DO NOT EDIT.

package {{packageName}}

import (
    "context"
    "fmt"
    "net/http"
    "net/url"
    "reflect"
    "strings"
    "time"

    aulogging "github.com/StephanHCB/go-autumn-logging"
    auapmclient "github.com/StephanHCB/go-autumn-restclient-apm/implementation/client"
    aurestbreakerprometheus "github.com/StephanHCB/go-autumn-restclient-circuitbreaker-prometheus"
    aurestbreaker "github.com/StephanHCB/go-autumn-restclient-circuitbreaker/implementation/breaker"
    aurestclientprometheus "github.com/StephanHCB/go-autumn-restclient-prometheus"
    aurestclientapi "github.com/StephanHCB/go-autumn-restclient/api"
    aurestcaching "github.com/StephanHCB/go-autumn-restclient/implementation/caching"
    auresthttpclient "github.com/StephanHCB/go-autumn-restclient/implementation/httpclient"
    aurestrecorder "github.com/StephanHCB/go-autumn-restclient/implementation/recorder"
    aurestlogging "github.com/StephanHCB/go-autumn-restclient/implementation/requestlogging"
    aurestretry "github.com/StephanHCB/go-autumn-restclient/implementation/retry"
    "github.com/go-http-utils/headers"
{{#imports}}    "{{import}}"
{{/imports}}
)

const Authorization_ctx_value = "authorization"

type Client interface {
    Setup() error

{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}
    {{{nickname}}}Request(ctx context.Context{{#pathParams}}, {{paramName}} {{{dataType}}}{{/pathParams}}) {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request
    {{{nickname}}}(ctx context.Context{{#pathParams}}, {{paramName}} {{{dataType}}}{{/pathParams}}{{#bodyParams}}, {{paramName}} {{{dataType}}}{{/bodyParams}}{{#queryParams}}, {{paramName}} {{{dataType}}}{{/queryParams}}) ({{#returnType}}{{{.}}}, {{/returnType}}error)
{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}
}

type RequestManipulatorFunc func(ctx context.Context, r *http.Request)

func BasicAuthRequestManipulator(username string, password string) RequestManipulatorFunc {
	return func(ctx context.Context, r *http.Request) {
		r.SetBasicAuth(username, password)
	}
}

type ClientConfig struct {
	BaseUrl string

	CacheRetention time.Duration
	CacheSize      int

	RequestManipulator              RequestManipulatorFunc
	AuthorizationRequestManipulator RequestManipulatorFunc
	TracingRequestManipulator       RequestManipulatorFunc
	LoggingConfigurer               func(client aurestclientapi.Client) aurestclientapi.Client
	CircuitBreakerConfigurer        func(client aurestclientapi.Client) aurestclientapi.Client
	ApmConfigurer                   func(client aurestclientapi.Client) aurestclientapi.Client
	RetryConfigurer                 func(client aurestclientapi.Client) aurestclientapi.Client
	RecorderConfigurer              func(client aurestclientapi.Client) aurestclientapi.Client
	CachingConfigurer               func(client aurestclientapi.Client, cacheRetentionSeconds time.Duration, cacheSize int) aurestclientapi.Client
}

func DefaultApiClientConfig(baseUrl string) *ClientConfig {
	config := &ClientConfig{
		BaseUrl:                         baseUrl,
		RequestManipulator:              nil,
		AuthorizationRequestManipulator: authorizationHeaderSetter,
		TracingRequestManipulator:       nil,
		LoggingConfigurer:               setupLogging,
		CircuitBreakerConfigurer:        setupCircuitBreakerClient,
		ApmConfigurer:                   setupApm,
		RetryConfigurer:                 setupRetryClient,
		RecorderConfigurer:              setupRecorder,
		CachingConfigurer:               setupCachingClient,
		CacheRetention:                  60 * time.Second,
		CacheSize:                       1000,
	}
	config.RequestManipulator = requestHeaderManipulator(config)
	return config
}

type APIClient struct {
	Config *ClientConfig
	Client aurestclientapi.Client
}

func NewAPIClient(cfg *ClientConfig) Client {
    return &APIClient{
        Config: cfg,
        Client: nil,
    }
}

// --- setup ---
func (c *APIClient) Setup() error {
    if err := c.setupClientStack(); err != nil {
        return err
    }
    return nil
}

func (c *APIClient) setupClientStack() error {
    //allow tests to pre-populate
    if c.Client != nil {
        return nil
    }

	client, err := setupHttpClient(c.Config.RequestManipulator)
	if err != nil {
		return err
	}

    if c.Config.LoggingConfigurer != nil {
        client = c.Config.LoggingConfigurer(client)
    }

    if c.Config.CircuitBreakerConfigurer != nil {
        client = c.Config.CircuitBreakerConfigurer(client)
    }

    if c.Config.ApmConfigurer != nil {
        client = c.Config.ApmConfigurer(client)
    }

    if c.Config.RetryConfigurer != nil {
        client = c.Config.RetryConfigurer(client)
    }
    if c.Config.RecorderConfigurer != nil {
        client = c.Config.RecorderConfigurer(client)
    }
    if c.Config.CachingConfigurer != nil {
        client = c.Config.CachingConfigurer(client, c.Config.CacheRetention, c.Config.CacheSize)
    }

    c.Client = client

    return nil
}

func setupHttpClient(configuredHeaderManipulator func(ctx context.Context, r *http.Request)) (aurestclientapi.Client, error) {
    client, err := auresthttpclient.New(0, nil, configuredHeaderManipulator)
    if err != nil {
        return nil, err
    }
    aurestclientprometheus.InstrumentHttpClient(client)

    return client, nil
}

func requestHeaderManipulator(config *ClientConfig) func(ctx context.Context, r *http.Request) {
	return func(ctx context.Context, r *http.Request) {
		r.Header.Set(headers.Accept, aurestclientapi.ContentTypeApplicationJson)

		if config != nil && config.AuthorizationRequestManipulator != nil {
			config.AuthorizationRequestManipulator(ctx, r)
		}

		if config != nil && config.TracingRequestManipulator != nil {
			config.TracingRequestManipulator(ctx, r)
		}
	}
}

func authorizationHeaderSetter(ctx context.Context, r *http.Request) {
	ctxAuthorizationValue := ctx.Value(Authorization_ctx_value)
	if ctxAuthorizationValue != nil {
		ctxAuthrizationValueStr, ok := ctxAuthorizationValue.(string)
		if ok && ctxAuthrizationValueStr != "" {
			r.Header.Set(headers.Authorization, ctxAuthrizationValueStr)
		}
	}
}

func setupCircuitBreakerClient(client aurestclientapi.Client) aurestclientapi.Client {
    circuitBreakerWrapper := aurestbreaker.New(
        client,
        "{{appName}}",
        100,
        5*time.Minute,
        60*time.Second,
        // includes possible retries, once the context is cancelled further requests will fail directly
        15*time.Second,
    )
    aurestbreakerprometheus.InstrumentCircuitBreakerClient(circuitBreakerWrapper)
    return circuitBreakerWrapper
}

func setupRetryClient(client aurestclientapi.Client) aurestclientapi.Client {
    retryWrapper := aurestretry.New(
        client,
        3,
        retryCondition(),
        betweenFailureAndRetry(),
    )
    aurestclientprometheus.InstrumentRetryClient(retryWrapper)
    return retryWrapper
}

func retryCondition() aurestclientapi.RetryConditionCallback {
    return func(_ context.Context, response *aurestclientapi.ParsedResponse, err error) bool {
        return response.Status == http.StatusServiceUnavailable
    }
}

func betweenFailureAndRetry() aurestclientapi.BeforeRetryCallback {
    return func(ctx context.Context, originalResponse *aurestclientapi.ParsedResponse, originalError error) error {
        aulogging.Logger.Ctx(ctx).Warn().Print("got 503 from {{appName}}-endpoint - retrying request")
        return nil
    }
}

func setupCachingClient(client aurestclientapi.Client, cacheRetentionSeconds time.Duration, cacheSize int) aurestclientapi.Client {
    cacheWrapper := aurestcaching.New(
        client,
        func(ctx context.Context, method string, url string, requestBody interface{}) bool {
            return method == http.MethodGet
        },
        func(ctx context.Context, method string, url string, requestBody interface{}, response *aurestclientapi.ParsedResponse) bool {
            return response != nil && response.Status == http.StatusOK
        },
        nil,
        cacheRetentionSeconds,
        cacheSize,
    )
    aurestclientprometheus.InstrumentCacheClient(cacheWrapper)
    return cacheWrapper
}

func setupLogging(client aurestclientapi.Client) aurestclientapi.Client {
    return aurestlogging.New(client)
}

func setupApm(client aurestclientapi.Client) aurestclientapi.Client {
    return auapmclient.New(client)
}

func setupRecorder(client aurestclientapi.Client) aurestclientapi.Client {
    return aurestrecorder.New(client)
}

// --- request implementations ---

func (c *APIClient) call(ctx context.Context, method string, requestUrl string, requestBody interface{}, responseBodyPointer interface{}) error {
    response := &aurestclientapi.ParsedResponse{
        Body: responseBodyPointer,
    }
    err := c.Client.Perform(ctx, method, requestUrl, requestBody, response)
    if err != nil {
        return err
    }

    switch response.Status {
        case
            http.StatusOK,
            http.StatusCreated,
            http.StatusAccepted,
            http.StatusNoContent:
        return nil
    }

    return fmt.Errorf("received unexpected status %d from {{appName}} %s %s", response.Status, method, requestUrl)
}

// ---- api methods
{{#apiInfo}}
{{#apis}}
{{#operations}}
{{#operation}}

type {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request struct {
    ctx context.Context{{#generateInterfaces}}
    ApiService APIClient
{{/generateInterfaces}}{{^generateInterfaces}}
    ApiService *APIClient
{{/generateInterfaces}}
{{#allParams}}
    {{paramName}} {{^isPathParam}}{{^isFile}}*{{/isFile}}{{/isPathParam}}{{{dataType}}}
{{/allParams}}
}

{{#allParams}}
{{^isPathParam}}
{{#description}}
    // {{.}}
{{/description}}
{{#isDeprecated}}
    // Deprecated
{{/isDeprecated}}
func (r {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request) {{vendorExtensions.x-export-param-name}}({{paramName}} {{{dataType}}}) {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request {
    r.{{paramName}} = {{^isFile}}&{{/isFile}}{{paramName}}
    return r
}

{{/isPathParam}}
{{/allParams}}
func (r {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request) Execute() ({{#returnType}}{{{.}}}, {{/returnType}}error) {
    return r.ApiService.{{nickname}}Execute(r)
}

func (a *APIClient) {{{nickname}}}Request(ctx context.Context{{#pathParams}}, {{paramName}} {{{dataType}}}{{/pathParams}}) {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request {
    return {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request{
        ApiService: a,
        ctx: ctx,
{{#pathParams}}
        {{paramName}}: {{paramName}},
{{/pathParams}}
    }
}

{{#isDeprecated}}
// Deprecated
{{/isDeprecated}}
func (a *APIClient) {{nickname}}Execute(r {{#structPrefix}}{{&classname}}{{/structPrefix}}{{^structPrefix}}Api{{/structPrefix}}{{operationId}}Request) ({{#returnType}}{{{.}}}, {{/returnType}}error) {
    requestURL, _ := url.Parse(a.Config.BaseUrl + "{{{path}}}")
{{#pathParams}}
    withURLPathParam(requestURL, "{"+"{{baseName}}"+"}", parameterValueToString(r.{{paramName}}))
{{/pathParams}}
{{#queryParams}}
    withUrlQueryParam(requestURL, "{{baseName}}", parameterValueToString(r.{{paramName}}))
{{/queryParams}}

    response := {{#returnType}}{{{.}}}{} {{/returnType}}{{^returnType}}new(any){{/returnType}}
    err := a.call(r.ctx, http.Method{{httpMethod}}, requestURL.String(), {{#bodyParams}}r.{{paramName}}{{/bodyParams}}{{^bodyParams}}nil{{/bodyParams}}, &response)
    return {{#returnType}}response, {{/returnType}}err
}

func (a *APIClient) {{{nickname}}}(ctx context.Context{{#pathParams}}, {{paramName}} {{{dataType}}}{{/pathParams}}{{#bodyParams}}, {{paramName}} {{{dataType}}}{{/bodyParams}}{{#queryParams}}, {{paramName}} {{{dataType}}}{{/queryParams}}) ({{#returnType}}{{{.}}}, {{/returnType}}error) {
    requestURL, _ := url.Parse(a.Config.BaseUrl + "{{{path}}}")
{{#pathParams}}
    withURLPathParam(requestURL, "{"+"{{baseName}}"+"}", parameterValueToString({{paramName}}))
{{/pathParams}}
{{#queryParams}}
    withUrlQueryParam(requestURL, "{{baseName}}", parameterValueToString({{paramName}}))
{{/queryParams}}

    response := {{#returnType}}{{{.}}}{} {{/returnType}}{{^returnType}}new(any){{/returnType}}
    err := a.call(ctx, http.Method{{httpMethod}}, requestURL.String(), {{#bodyParams}}{{paramName}}{{/bodyParams}}{{^bodyParams}}nil{{/bodyParams}}, &response)
    return {{#returnType}}response, {{/returnType}}err
}
{{/operation}}
{{/operations}}
{{/apis}}
{{/apiInfo}}


// ---- helper methods

func withURLPathParam(u *url.URL, param, val string) *url.URL {
    u.Path = strings.ReplaceAll(u.Path, param, val)
    return u
}

func withUrlQueryParam(requestUrl *url.URL, valueName string, value string) {
    if value != "" {
        queryParams := requestUrl.Query()
        queryParams.Set(valueName, value)
        requestUrl.RawQuery = queryParams.Encode()
    }
}

func parameterValueToString( obj interface{} ) string {
    if reflect.TypeOf(obj).Kind() != reflect.Ptr {
        return fmt.Sprintf("%v", obj)
    }
    return ""
}